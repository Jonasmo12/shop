{% extends "../base.html" %}
{% load static %}
{% block title %}Cart Summary{% endblock %}
{% block content %}

{% include '_navBar.html' %}
<div class="container mt-5">
  <div class="row">
    <div class="col-lg-12">
      <div class="accordion" id="accordionExample">
        <div class="accordion-item">
          <h2 class="accordion-header" id="headingOne">
            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
              Cart Summary
            </button>
          </h2>
          <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#accordionExample">
            <div class="accordion-body">
              <div class="row g-3">
                <div class="col-lg-12">
          
                  {% for item in cart %} 
                  {% with product=item.product %}
          
                  <div class="card mb-3 border-0 product-item" data-index="{{product.id}}">
                    <div class="row g-0">
                      <div class="col-md-2 d-none d-md-block">
                        <img class="img-fluid mx-auto d-block" alt="Responsive image"
                            src="{{ product.image.url }}" height="50px" width="50px"/>
                      </div>
                      <div class="col-md-10 ps-md-3">
                        <div class="card-body p-1">
                          <a class="text-decoration-none text-reset" href="{{item.shop.product.get_absolute_url}}">
                            <p class="card-text pb-3">{{product.title}}</p>
                          </a>
                              <label for="select">Quantity</label>
                              <select id="select{{product.id}}" style="width:50px;height:31px;">
                                <option value="" selected disabled hidden>{{item.quantity}}</option>
                                <option value="">1</option>
                                <option value="">2</option>
                                <option value="">3</option>
                                <option value="">4</option>
                              </select>
                          <a type="button" id="update-button" data-index="{{product.id}}" class="update-button text-decoration-none small ps-3">Update</a>
                          <a type="button" id="delete-button" data-index="{{product.id}}" class="delete-button text-decoration-none small">Delete</a>
                        </div>
                      </div>
                    </div>
                  </div>
                  {% endwith %} 
                  {% endfor %}
                </div>

                <div class="col-lg-12 text-end">
                    
                  <div class="">Sub Total: <span class="fw-bold">R </span><div id="subtotal" class="d-inline-flex fw-bold">{{cart.get_subtotal_price}}</div></div>
            
                  <div class="pt-2">Total to pay: <span class="fw-bold h5">R </span><span id="total_price" class="fw-bold h5">{{cart.get_total_price}}</span></div>
                  
                </div>
              </div>
              <!-- <div class="col-md-5 col-lg-4 order-md-last p-0 order-3">
                <div class="d-grid gap-2 ">
                  <a role="button" href="{% url 'payment:cart' %}" class="btn btn-success fw-bold" type="button">Checkout</a>
                  <button class="btn btn-light" type="button">Save for later</button>
                </div>
              </div> -->
              </div>
            </div>
          </div>
        </div>
        <div class="accordion-item">
          <h2 class="accordion-header" id="headingTwo">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
              Checkout
            </button>
          </h2>
          <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#accordionExample">
            <div class="accordion-body">
              <form id="payment-form" method="POST">
                <div class="one-liner">
                  <div id="card-frame">
                    <!-- Yoco Inline form will be added here -->
                  </div>
                  <br>
                  <button class="btn btn-md btn-primary" id="pay-button">
                    Pay
                  </button>
                </div>
                <p class="success-payment-message"></p>
              </form>
                    
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<script>
  // {% comment %} Make csrf token availble in JS files {% endcomment %}
    var CSRF_TOKEN = '{{ csrf_token }}';
    var cartTotal = '{{ cart.get_total_price}}';
    var cartTotal = cartTotal.toString();
    var cartTotal = cartTotal.replace('.', '');
    var cartTotal = parseInt(cartTotal)
    var shopInstace = '{{ cart.product.shop }}';
    console.log(shopInstace)

    var order_url = "{% url 'order:add' %}";
  
  
    // Delete Item
  $(document).on('click', '.delete-button', function (e) {
    e.preventDefault();
    var prodid = $(this).data('index');
    $.ajax({
      type: 'POST',
      url: '{% url "cart:cart_delete" %}',
      data: {
        product_id: $(this).data('index'),
        csrfmiddlewaretoken: "{{csrf_token}}",
        action: 'post'
      },
      success: function (json) {
        $('.product-item[data-index="' + prodid + '"]').remove();
        document.getElementById("subtotal").innerHTML = json.subtotal;
        document.getElementById("cart-quantity").innerHTML = json.cart-quantity
      },
      error: function (xhr, errmsg, err) {}
    });
  })

  // Update Item
  $(document).on('click', '.update-button', function (e) {
    e.preventDefault();
    var prodid = $(this).data('index');
    $.ajax({
      type: 'POST',
      url: '{% url "cart:cart_update" %}',
      data: {
        product_id: $(this).data('index'),
        product_quantity: $('#select' + prodid + ' option:selected').text(),
        csrfmiddlewaretoken: "{{csrf_token}}",
        action: 'post'
      },
      success: function (json) {
        console.log(json.cart_quantity)
        console.log(json.subtotal)
        document.getElementById("cart-quantity").innerHTML = json.cart_quantity
        document.getElementById("subtotal").innerHTML = json.subtotal
        document.getElementById("total_price").innerHTML = json.total_price

      },
      error: function (xhr, errmsg, err) {}
    });
  })
</script>

<script src="{% static 'payment.js' %}" data-rel-js></script>
{% endblock %}